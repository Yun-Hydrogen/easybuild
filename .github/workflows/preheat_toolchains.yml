name: Cache Toolchains

on:
  workflow_dispatch:

env:
  CLANG_REPO: https://github.com/blacklytning/clang-13.0.1.git
  CLANG_BRANCH: 11
  GCC64_REPO: https://github.com/JackA1ltman/Google-GCC-Android-4.9.git
  GCC64_BRANCH: aarch64
  GCC32_REPO: https://github.com/JackA1ltman/Google-GCC-Android-4.9.git
  GCC32_BRANCH: arm32

jobs:
  cache-toolchains:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout (for workflow context)
        uses: actions/checkout@v4

      - name: Restore clang cache
        uses: actions/cache@v4
        with:
          path: clang
          key: clang-${{ env.CLANG_BRANCH }}-${{ runner.os }}-${{ hashFiles('**/clang/**') }}
          restore-keys: |
            clang-${{ env.CLANG_BRANCH }}-${{ runner.os }}-
            clang-${{ runner.os }}-

      - name: Restore gcc64 cache
        uses: actions/cache@v4
        with:
          path: gcc64
          key: gcc64-${{ env.GCC64_BRANCH }}-${{ runner.os }}-${{ hashFiles('**/gcc64/**') }}
          restore-keys: |
            gcc64-${{ env.GCC64_BRANCH }}-${{ runner.os }}-
            gcc64-${{ runner.os }}-

      - name: Restore gcc32 cache
        uses: actions/cache@v4
        with:
          path: gcc32
          key: gcc32-${{ env.GCC32_BRANCH }}-${{ runner.os }}-${{ hashFiles('**/gcc32/**') }}
          restore-keys: |
            gcc32-${{ env.GCC32_BRANCH }}-${{ runner.os }}-
            gcc32-${{ runner.os }}-

      - name: Ensure git is available
        run: sudo apt-get update && sudo apt-get install -y git

      - name: Clone clang if missing
        run: |
          if [ ! -d clang ] || [ -z "$(ls -A clang 2>/dev/null)" ]; then
            echo "Cloning clang..."
            rm -rf clang
            git clone --depth=1 --branch $CLANG_BRANCH $CLANG_REPO clang
          else
            echo "clang directory exists, skip clone."
          fi

      - name: Clone gcc64 if missing
        run: |
          if [ ! -d gcc64 ] || [ -z "$(ls -A gcc64 2>/dev/null)" ]; then
            echo "Cloning gcc64..."
            rm -rf gcc64
            git clone --depth=1 --branch $GCC64_BRANCH $GCC64_REPO gcc64
          else
            echo "gcc64 directory exists, skip clone."
          fi

      - name: Clone gcc32 if missing
        run: |
          if [ ! -d gcc32 ] || [ -z "$(ls -A gcc32 2>/dev/null)" ]; then
            echo "Cloning gcc32..."
            rm -rf gcc32
            git clone --depth=1 --branch $GCC32_BRANCH $GCC32_REPO gcc32
          else
            echo "gcc32 directory exists, skip clone."
          fi

      - name: Verify toolchains
        run: |
          echo "clang version:"
          clang --version || true
          echo "gcc64 binaries:"
          ls -la gcc64/bin || true
          echo "gcc32 binaries:"
          ls -la gcc32/bin || true

      - name: Done
        run: echo "Toolchain cache workflow finished. If caches were missing, they will be saved automatically by actions/cache."
