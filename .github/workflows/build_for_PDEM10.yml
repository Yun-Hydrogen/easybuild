name: Build Kernel (PDEM10)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    env:
      KERNEL_REPO: https://github.com/Yun-Hydrogen/Oppo_Findx2_Sukisu_Kernel.git
      KERNEL_BRANCH: oss-t
      CLANG_REPO: https://github.com/blacklytning/clang-13.0.1.git
      CLANG_BRANCH: 11
      GCC64_REPO: https://github.com/JackA1ltman/Google-GCC-Android-4.9.git
      GCC64_BRANCH: aarch64
      GCC32_REPO: https://github.com/JackA1ltman/Google-GCC-Android-4.9.git
      GCC32_BRANCH: arm32
      AK3_SOURCE: https://github.com/osm0sis/AnyKernel3.git
      AK3_BRANCH: master
      DEFCONFIG: stock_defconfig
      ARCH: arm64
      DEVICE: PDEM10

    steps:
    - name: Checkout kernel
      uses: actions/checkout@v4
      with:
        repository: ${{ env.KERNEL_REPO }}
        ref: ${{ env.KERNEL_BRANCH }}
        path: kernel

    - name: Install deps & Python2
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential bc bison flex libssl-dev libncurses-dev ccache python2 git wget
        sudo ln -sf /usr/bin/python2 /usr/bin/python

    - name: Clone toolchains
      run: |
        git clone --depth=1 --branch $CLANG_BRANCH $CLANG_REPO clang
        git clone --depth=1 --branch $GCC64_BRANCH $GCC64_REPO gcc64
        git clone --depth=1 --branch $GCC32_BRANCH $GCC32_REPO gcc32

    - name: Export toolchain env
      run: |
        export PATH=$PWD/clang/bin:$PWD/gcc64/bin:$PWD/gcc32/bin:$PATH
        echo "PATH=$PATH" >> $GITHUB_ENV
        # 假定 gcc64 前缀 为 aarch64-linux-android- , gcc32 为 arm-linux-androideabi-
        echo "CROSS_COMPILE_AARCH64=aarch64-linux-android-" >> $GITHUB_ENV
        echo "CROSS_COMPILE_ARM=arm-linux-androideabi-" >> $GITHUB_ENV
        echo "CLANG_BIN=$PWD/clang/bin/clang" >> $GITHUB_ENV

    - name: Prepare build output dir
      working-directory: kernel
      run: |
        export ARCH=${{ env.ARCH }}
        make O=out ARCH=$ARCH ${DEFCONFIG}

    - name: Compile kernel with clang
      working-directory: kernel
      run: |
        export ARCH=${{ env.ARCH }}
        export PATH=$PWD/../clang/bin:$PWD/../gcc64/bin:$PWD/../gcc32/bin:$PATH
        export CROSS_COMPILE=${CROSS_COMPILE_AARCH64}
        export CC=clang
        make -j$(nproc) O=out ARCH=$ARCH CC=clang \
          LLVM=1 \
          CLANG_TRIPLE=aarch64-linux-gnu- \
          HOSTCC=gcc

    - name: Collect artifacts
      working-directory: kernel
      run: |
        mkdir -p release
        # 不包含 dtb/dtbo，仅拷贝内核镜像（根据内核版本可能为 Image, Image.gz, Image.gz-dtb）
        if [ -f out/arch/arm64/boot/Image.gz ]; then cp out/arch/arm64/boot/Image.gz release/; fi
        if [ -f out/arch/arm64/boot/Image ]; then cp out/arch/arm64/boot/Image release/; fi
        ls -lah release

    - name: AnyKernel3 package (no dtb/dtbo)
      run: |
        git clone --depth=1 --branch $AK3_BRANCH $AK3_SOURCE AnyKernel3
        mkdir -p AnyKernel3/kernel
        cp kernel/release/* AnyKernel3/kernel/
        cd AnyKernel3
        zip -r ../${{ env.DEVICE }}-kernel.zip . -x "dtb/*" "dtbo/*"

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.DEVICE }}-kernel
        path: ${{ env.DEVICE }}-kernel.zip
